<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Source+Code+Pro&display=swap" rel="stylesheet">    <title>Puzzle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://kit.fontawesome.com/d2bdb5ef52.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body class="p-0 bg-red-200">
    <div class="flex flex-col h-screen">
        <h2 id="module-heading" class="bg-pink-400 border border-1 border-red-500">
            <div class="flex items-center justify-between w-full font-bold px-3 p-0 text-3vw text-black-500 gap-3" data-accordion-target="#submodule-body-1" aria-expanded="true" aria-controls="submodule-body-1">
                <p class="flex items-center justify-start">
                    <img src="images/kitty-animated.gif" width="12%" class="me-2"/>
                    Progreso de ejercicios
                </p>
                <div class="flex justify-end">
                    <button type="button" id="back" class="me-2 px-1 border border-2 border-black bg-black text-pink-600 rounded"><i class="fa fa-arrow-left"></i></button>
                    <button type="button" id="home" class="me-2 px-1 border border-2 border-black bg-black text-pink-600 rounded"><i class="fa fa-home"></i></button>
                </div>
            </div>
        </h2>
        <div class="w-full px-3 p-2 text-black-500 gap-3" data-accordion-target="#submodule-body-1" aria-expanded="true" aria-controls="submodule-body-1">
            <p class="my-3">A medida que vayas completando los ejercicios, sólo podrás registrar tu progreso de 2 formas:</p>
            <p>
                <ul>
                    <li><strong>1) Por una cookie de tu navegador</strong>: Este es el método por default. No requiere ninguna acción de tu parte y es automática. Recuerda que si tu navegador no acepta cookies no se podrá guardar el progreso. Además, si la cookie se borrara/venciera entonces perderás todo tu progreso.</li>
                    <li><strong>2) Generando un código de progreso</strong>: Este método te permite generar un texto codificado que deberás guardar seguro en un archivo de texto. Contiene el "ADN" de tu avance en los ejercicios. Si por algo perdiste tu progreso, podrás ingresar el último código generado que tengas y recuperarás el progreso hasta esa fecha.</li>
                </ul>
            </p>
        </div>
        <div id="options" class="w-full mt-3 p-3 grid grid-cols-2 gap-3">
            <button type="button" id="getCode" class="p-2 me-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-green-500">Generar código de progreso</button>
            <button type="button" id="enterCode" class="p-2 ms-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-red-500">Ingresar código de progreso</button>
        </div>
        <div id="obtainCode" class="w-full flex mt-3 p-3 hidden">
            <input id='inputGetCode' readonly class="placeholder:italic placeholder:bold placeholder:text-red-400 block bg-pink-100 w-full border border-pink-500 rounded-md py-2 pl-9 pr-3 shadow-sm focus:outline-none focus:border-sky-500 focus:ring-sky-500 focus:ring-1 text-red-500 text-3vw" type="text"/>
            <button type="button" id="copy" class="p-2 mx-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-green-500">Copiar<i class="fa fa-copy p-1 pl-2"></i></button>
            <button type="button" id="cancelGet" class="p-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-gray-500">Cancelar<i class="fa fa-cancel p-1 pl-2"></i></button>
        </div>
        <div id="insertCode" class="w-full flex mt-3 p-3 hidden">
            <label class="relative flex-auto block w-full">
                <span class="sr-only">Search</span>
                <span class="absolute inset-y-0 left-0 flex items-center pl-2">
                  <i class="text-3vw text-slate-400 fa fa-search me-2"></i>
                </span>
                <input id='inputSetCode' class="placeholder:italic placeholder:bold placeholder:text-red-400 block bg-pink-100 w-full border border-pink-500 rounded-md py-2 pl-9 pr-3 shadow-sm focus:outline-none focus:border-sky-500 focus:ring-sky-500 focus:ring-1 text-red-500 text-3vw" placeholder=" Ingresá, o copiá y pegá aquí tu código de progreso" type="text" name="search"/>
            </label>
            <button type="button" id="set" disabled class="p-2 mx-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-gray-300">Procesar<i class="fa fa-cog p-1 pl-2"></i></button>
            <button type="button" id="cancelSet" class="p-2 flex-1 text-3vw flex justify-center font-bold border-solid border-2 border-black text-white bg-gray-500">Cancelar<i class="fa fa-cancel p-1 pl-2"></i></button>
        </div>
    </div>
</body>
<script src="exercises.js"></script>
<script src="cookies.js"></script> 
 
<script>

    //Get cookie with progress.
    let progress = getCookie("progress") ? JSON.parse(getCookie("progress")) : []
    let errorCode = ""

    //Initialize alerts.
    let alert = (alertStructure, callback = false) => {
        Swal.fire(alertStructure).then((result) => {
            if(callback){
                if (result.isConfirmed) {
                    /* Get the text field */
                    let copyError = document.getElementById("inputErrorCode");
                    /* Select the text field */
                    copyError.select();
                    /* Copy the text inside the text field */
                    document.execCommand("copy");
                    Swal.fire("", "Se copió el código "+copyError.value+" al portapapeles. Pegalo en el mensaje a tu profe.", "success");
                }
            }
        })
    }

    //Structures for different types of alerts.
    let alertCodeCopied = {
        title: 'Bravo!',
        text: 'Copiaste tu código de progreso al portapapeles. Pegalo en un archivo de texto y guardalo.',
        confirmButtonText: 'De acuerdo'
    }
    let alertCodeProccesed = {
        title: 'Bravo!',
        text: 'Tu código de progreso pudo ser procesado correctamente. Ya tienes tu progreso actualizado.',
        confirmButtonText: 'De acuerdo'
    }
    
    //Event handler after clicking button to get progress code
    let clickGetCode = (e) => {
        document.querySelector("#inputGetCode").value = ""
        progress.forEach((exerciseString) => {
            document.querySelector("#inputGetCode").value += ";"+exerciseString;
        })
        document.querySelector("#inputGetCode").value = document.querySelector("#inputGetCode").value.substr(1)
        document.querySelector("#obtainCode").classList.remove("hidden")
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) => elem.setAttribute("disabled", true))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.remove("bg-green-500"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.remove("border-black-500"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.add("bg-gray-300"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.add("border-gray-500"))
    }

    document.querySelector("#getCode").addEventListener('click', clickGetCode);

    // Event handler for clicking Copy progress code.
    var clickCopyCode = (e) => {
        /* Get the text field */
        let copyText = document.getElementById("inputGetCode");
        /* Select the text field */
        copyText.select();
        /* Copy the text inside the text field */
        document.execCommand("copy");
        alert(alertCodeCopied)
    }

    document.querySelector("#copy").addEventListener('click', clickCopyCode);
    
    // Event handler for clicking Cancel get progress code.
    var clickCancelGetCode = (e) => {
        document.querySelector("#obtainCode").classList.add("hidden")
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) => elem.removeAttribute("disabled", true))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.add("bg-green-500"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.add("border-black-500"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.remove("bg-gray-300"))
        document.querySelectorAll("#getCode, #enterCode").forEach((elem) =>elem.classList.remove("border-gray-500"))
    }

    document.querySelector("#cancelGet").addEventListener('click', clickCancelGetCode);

    //Event handler after clicking button to set progress code
    let clickEnterCode = (e) => {
        document.querySelector("#insertCode").classList.remove("hidden")
        document.querySelector("#inputSetCode").value = ""
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.setAttribute("disabled", true))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.remove("bg-green-500"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.remove("border-black-500"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.add("bg-gray-300"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.add("border-gray-500"))
    }

    document.querySelector("#enterCode").addEventListener('click', clickEnterCode);

    // Event handler for clicking Copy progress code.
    var clickProcessCode = (e) => {
        /* Get the text field */
        let codeText = document.getElementById("inputSetCode").value;
        errorCode = ""
        //Evaluate typed code syntax.
        //1) Split string into an array separated by ;
        let codeTextArray = codeText.split(";")
        //2) Iterate array.
        let exerciseNbr = 0
        codeTextArray.forEach((exercise) => {
            //Parse exercise code
            let exerciseLen = exercise.length
            //3) Check if Mxx exists inside string, and in the right position.
            const expMxx = /^M\d\d/
            let Mxx = exercise.match(expMxx) != null ? exercise.match(expMxx).index : null
            errorCode = !errorCode && Mxx == null ? "E1"+exerciseNbr.toString().padStart(3, "0") : errorCode //Module recognition failure.
            if(!errorCode){
                //4) Check if Sxx exists inside string, and in the right position (following Mxx)
                const expMxxSxx = /^M\d\dS\d\d/
                let Sxx = exercise.match(expMxxSxx) != null ? exercise.match(expMxxSxx).index : null
                errorCode = !errorCode && Sxx == null ? "E2"+exerciseNbr.toString().padStart(3, "0") : errorCode //Submodule recognition failure.
                if(!errorCode){
                    //5) Check if Exx exists inside string, and in the right position (following Sxx)
                    const expMxxSxxExx = /^M\d\dS\d\dE\d\d/
                    let Exx = exercise.match(expMxxSxxExx) != null ? exercise.match(expMxxSxxExx).index : null
                    errorCode = !errorCode && Exx == null ? "E3"+exerciseNbr.toString().padStart(3, "0") : errorCode //Exercise recognition failure.
                    if(!errorCode){
                        //6) Check if Fx exists inside string, and in the right position (following Exx)
                        const expMxxSxxExxFx = /^M\d\dS\d\dE\d\dF\d/
                        let Fx = exercise.match(expMxxSxxExxFx) != null ? exercise.match(expMxxSxxExxFx).index : null
                        errorCode = !errorCode && Fx == null ? "E4"+exerciseNbr.toString().padStart(3, "0") : errorCode //Exercise recognition failure.
                        if(!errorCode){
                            //7) Check if Ax exists inside string, and in the right position (following Exx)
                            const expMxxSxxExxFxAx = /^M\d\dS\d\dE\d\dF\dA\d/
                            let Ax = exercise.match(expMxxSxxExxFxAx) != null ? exercise.match(expMxxSxxExxFx).index : null
                            errorCode = !errorCode && Ax == null ? "E5"+exerciseNbr.toString().padStart(3, "0") : errorCode //Exercise recognition failure.
                        }
                    }
                }
            }
            exerciseNbr++
        })
        if(errorCode){
            let alertCodeWrong = {
                title: '🤦🏻‍♂️ Oops!',
                showDenyButton: true,
                confirmButtonText: "Copiar código al portapapeles",
                denyButtonText: "Oh 😔. Intentaré reescribirlo",
                html: '<p class="text-left font-bold text-red-500">El código ingresado tiene un error.</p>'+
                    '<p class="text-left">Verificá que lo hayas seleccionado completamente y no falte ni una única letra o número. Pegalo nuevamente y volvé a procesarlo.</p>'+
                    '<p class="text-left mt-2">Si continúa el error, contacta a tu profesor y enviale el siguiente código:</p>'+
                    '<p class="text-left mt-2"><input id="inputErrorCode" type="text" class="font-bold w-17 text-center border border-slate-300 rounded-md py-2 shadow-sm" value="'+errorCode+'"/>',
            }
            alert(alertCodeWrong, callback = true)
        } else {
            //Set cookie with parsed progress code.
            setCookie("progress", JSON.stringify(codeText.split(";")), 60)
            alert(alertCodeProccesed)
        }
    }

    document.querySelector("#set").addEventListener('click', clickProcessCode);
    
    // Event handler for clicking Copy progress code.
    var changeCode = (e) => {
        if(e.target.value != ""){
            document.querySelector("#set").classList.remove("bg-gray-300")
            document.querySelector("#set").classList.add("bg-green-500")
            document.querySelector("#set").removeAttribute("disabled")
        } else {
            document.querySelector("#set").classList.add("bg-gray-300")
            document.querySelector("#set").classList.remove("bg-green-500")
            document.querySelector("#set").addAttribute("disabled")
        }
    }
    document.querySelector("#inputSetCode").addEventListener('keyup', changeCode);

    // Event handler for clicking Cancel set progress code.
    var clickCancelEnterCode = (e) => {
        document.querySelector("#insertCode").classList.add("hidden")
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.removeAttribute("disabled"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.add("bg-green-500"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.add("border-black-500"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.remove("bg-gray-300"))
        document.querySelectorAll("#enterCode, #getCode").forEach((elem) =>elem.classList.remove("border-gray-500"))
    }

    document.querySelector("#cancelSet").addEventListener('click', clickCancelEnterCode);

    // Event handler for clicking back.
    var backClick = (e) => {
        window.history.back()
    }

    document.querySelector("#back").addEventListener('click', backClick);

    // Event handler for clicking home.
    var homeClick = (e) => {
        window.location = "./"
    }

    document.querySelector("#home").addEventListener('click', homeClick);
</script>
</html>